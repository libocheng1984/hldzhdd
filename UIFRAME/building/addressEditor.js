function AddressEditor(b,e){var c=this;this.option;var d=0;var j;var k;var h;this.install=function(){j=$('<div class="address_wraper"><h1>地址编辑器</h1><div class="address_addressbox"></div></div>');var p=$('<div class="address_submitbox"><a id="address_finish">完成</a><a id="address_cancel">取消</a></div>');b.append(j).append(p);p.find("a").bind("click",f);h=j.find(">.address_addressbox");q()};function q(){l();var s=h.find(">dd:last");if(s.length>0){if(!s.data("guid")){$.message("前一级地址未完成，不能添加下级。");return}var r=$('<dd><input type="text" name="key" placeholder="请输入关键字"><a><i class="fa fa-search"></i></a><span></span></dd>');s.after(r)}else{var r=$('<dd><input type="text" name="key" placeholder="请输入关键字"><a><i class="fa fa-search"></i></a><span></span></dd>');h.append(r)}r.data("parent",s.data("guid")).data("guid",null);var p=r.find(">input");r.find("a").bind("click",function(){if($(this).hasClass("disabled")){return}var u=trim(p.val());var v=s.data("guid");if(u||(u==""&&!v)){var t={"key":u,"parentid":v};c.Load(e,t,r)}else{$.message("请输入地址关键字。");return}});r.find("input").bind("change",n).bind("keydown",function(t){if(t.keyCode==13){$(this).parent().find("a").click()}})}function l(){h.find(">.onedit").each(function(){o($(this))})}function n(){var r=$(this).parent();var p=r.index();h.find("dd:gt("+p+")").del()}this.Load=function(s,p,r){var t=new AJAXObj();$(t).one("JSON_LOADED",function(w,u){var v=u["value"];g(v,r);r.find("a.disabled").removeClass("disabled").find("i").attr("class","fa fa-search")});r.find("a").addClass("disabled").find("i").attr("class","fa fa-spinner");t.POSTDATA(s,{"event":"load","content":{"condition":p}})};function g(u,r){h.find(".address_droplist").remove();var t=r.find(".address_droplist");if(t.length==0){t=$('<div class="address_droplist"></div>');r.append(t)}t.empty();for(var s=0;s<u.length;s++){var v=$("<p>"+u[s]["text"]+"</p>");v.data("value",u[s]);t.append(v)}t.find("p").bind("click",function(p){var w=$(this).text();a(r,w,$(this).data("value"));t.del();p.stopPropagation();p.preventDefault()})}function a(p,s,r){p.find("span").text(s);p.data("guid",r["value"]);p.data("level",r["level"]);p.find("input").val(s).change();p.find(".address_droplist").remove();o(p);if(p.index()==h.find(">dd").length-1){q()}}function m(r){l();var p=$(this).parent();p.find("span").hide();p.find("input,a").show();p.addClass("onedit");p.find(".address_droplist").remove()}function o(p){p.find("span").show().one("click",m);p.find("input,a").hide();p.removeClass("onedit");p.find(".address_droplist").remove()}function i(){var s="";var r="";var p="";h.find(">dd").each(function(){var t=$(this).data("guid");var u=$(this).find("span").text();var v=$(this).data("level");if(t){s+=u;r+=t+"/";p+=v+"/"}else{return false}});if(r.length>1){r=r.substr(0,r.length-1)}if(p.length>1){p=p.substr(0,p.length-1)}return{"addressText":s,"addressCode":r,"addressLevel":p}}function f(){switch($(this).attr("id")){case"address_finish":var p=i();$(c).trigger("NEW_ADDRESS",p);break;case"address_cancel":$(c).trigger("CLOSE_ADDRESS");break}}this.resize=function(){};this.destroy=function(){j.del();j=null};this.install()};