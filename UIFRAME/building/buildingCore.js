function BuildingCore(C){var H=this;this.option={"title":"装户图","space":6,"roomwidth":72,"roomheight":48,"minwidth":12,"minheight":8,"zoomstep":10,"zindex":999,"editable":true};this.buildingData=[];var K=[];this.isMergeing=false;var y=1;var h;var D;var a;var x;this.actionType="show";this.isEdit=false;this.rules;this.isNewBuilding=true;var J=0;this.rules={"pre":"","end":"","preunder":"B","premenshi":"商","danyuan":"num","partleng":1,"floorleng":1,"roomleng":1,"split":"-","singlequn":false};var u="ABCDEFGHIJKLMNOPQRSTUVWXYZ";this.destroy=function(){if(x){x.destroy();x=null}a.unbind().empty().remove();h.unbind().remove();C.unbind()};this.getCanvars=function(){return a};this.isDraged=function(){return x.draged};this.install=function(p){$.extend(H.option,p);h=$('<div class="bd_draggrid"></div>');h.css({"position":"relative","overflow":"hidden","width":C.width()+"px","height":C.height()+"px","z-index":H.option["zindex"]});D=$("<div></div>");D.css({"position":"absolute","top":"0px","left":"0px","z-index":H.option["zindex"]});a=$('<div class="bd_canvars"></div>');a.css({"position":"relative"});D.append(a);h.append(D);C.append(h);C.css({"overflow":"hidden"});x=new dragDivObj();x.holdTop=false;x.install(h,D,function(){return[C.offset().left,C.offset().top]});h.unbind("mousewheel").bind("mousewheel",l);h.unbind("contextmenu").bind("contextmenu",function(R){R.stopPropagation();R.preventDefault()});toolsBar=$('<div class="bd_tools">'+'<a id="building_zoomout" title="放大"><i class="fa fa-search-plus"></i></a>'+'<a id="building_zoomin" title="缩小"><i class="fa fa-search-minus"></i></a>'+'<a  id="building_center" title="居中"><i class="fa fa-dot-circle-o"></i></a>'+"</div>");C.append(toolsBar);toolsBar.css({"left":"5px","top":"5px","position":"absolute","z-index":H.option["zindex"]+1});toolsBar.find(">a").bind("click",i)};function i(){switch($(this).attr("id")){case"building_center":H.Center();break;case"building_zoomin":H.Zoom("in");break;case"building_zoomout":H.Zoom("out");break;case"building_refresh":H.refreshBuilding();break}}this.resize=function(){if(!h){return}h.css({"width":C.width()+"px","height":C.height()+"px"})};this.Center=function(){D.css({"top":Math.floor(C.height()-J*(H.option["space"]+H.option["roomheight"]))+"px","left":Math.floor((C.width()-a.width())/2)+"px"})};this.Zoom=function(p){switch(p){case"in":H.option["roomwidth"]-=H.option["zoomstep"];H.option["roomwidth"]=(H.option["roomwidth"]>H.option["minwidth"])?H.option["roomwidth"]:H.option["minwidth"];H.option["roomheight"]-=H.option["zoomstep"];H.option["roomheight"]=(H.option["roomheight"]>H.option["minheight"])?H.option["roomheight"]:H.option["minheight"];H.refreshSize();break;case"out":H.option["roomwidth"]+=H.option["zoomstep"];H.option["roomheight"]+=H.option["zoomstep"];H.refreshSize();break}};function l(p,R){H.Zoom(R>0?"out":"in");p.stopPropagation();return false}this.creatBuilding=function(R,S){for(var U=0;U<H.buildingData.length;U++){for(var p=0;p<H.buildingData[U]["children"].length;p++){for(var T=0;T<H.buildingData[U]["children"][p]["children"].length;T++){if(H.buildingData[U]["children"][p]["children"][T]["olddata"]==true){K.push(H.buildingData[U]["children"][p]["children"][T])}}}}H.buildingData=R;y=O();H.refreshBuilding(S)};function O(){var S=0;for(var T=0;T<H.buildingData.length;T++){for(var p=0;p<H.buildingData[T]["children"].length;p++){for(var R=0;R<H.buildingData[T]["children"][p]["children"].length;R++){S=Math.max(S,H.buildingData[T]["children"][p]["children"][R]["id"])}}}return S+1}this.refreshBuilding=function(ai){a.empty();var ad=0;var ac=0;var T=w(H.buildingData,"children");var ah=$('<div class="bd_groundColor"></div>');a.append(ah);var U=[];var W="none";var ak=0;for(var ab=0;ab<H.buildingData.length;ab++){var S=$('<div class="bd_danyuan"><div class="bd_danyuantitle"><p rel="'+ab+'">'+(H.buildingData[ab]["name"]||(ab+1))+"</p></div></div>");S.find(">.bd_danyuantitle").css({"position":"absolute","left":"0px","top":"-34px","width":"100%"});S.find(">.bd_danyuantitle p");a.append(S);H.buildingData[ab]["div"]=S;S.data({"D":ab,"data":H.buildingData[ab]});var ae=H.buildingData[ab]["children"];var ag=H.buildingData[ab]["ground"]?H.buildingData[ab]["ground"]:0;var V=H.buildingData[ab]["store"]?H.buildingData[ab]["store"]:0;J=Math.max(J,ag);var R=ag*(H.option["roomheight"]+H.option["space"]);for(var aa=0;aa<ae.length;aa++){var aj=ae[aa]["children"];var al=(aa<ag)?" bd_ground":"";var X=(aa>=ag&&aa<(ag+V))?" bd_store":"";var p=$('<div class="bd_floor'+(aj.length==0?" bd_blankfloor":"")+'"></div>');p.css({"position":"absolute","z-index":H.option["zindex"]});S.append(p);ae[aa]["div"]=p;p.data({"D":ab,"L":aa,"data":ae[aa]});for(var Z=0;Z<aj.length;Z++){var af=$('<div class="bd_room'+X+al+'"><div class="bd_roomcont"></div></div>');z(af,aj[Z]);af.css({"position":"absolute","z-index":H.option["zindex"]+1});aj[Z]["div"]=af;S.append(af);af.attr("id",aj[Z]["id"]);aj[Z]["groupid"]?af.attr("data-group",aj[Z]["groupid"]):null;if(aj[Z]["groupid"]&&aj[Z]["groupid"]!=W){U.push(aj[Z]["groupid"]);
W=aj[Z]["groupid"]}af.data({"D":ab,"L":aa,"R":Z,"data":aj[Z]})}}}for(var ab=0;ab<U.length;ab++){var Y=a.find("div[data-group="+U[ab]+"]");d(Y)}(H.buildingData.length==0)?ah.hide():ah.show();ah.css({"position":"absolute","left":"-20px","right":"-20px"});H.refreshSize();if(ai){H.Center()}H.resetAction(H.actionType);a.find(".bd_room").bind("mouseenter",Q)};this.getRealRoom=function(R){if(R["groupid"]){var p=R["groupid"];return e(p)||R}return R};this.refreshSize=function(){var af=0;var ae=0;var al=0;for(var ad=0;ad<H.buildingData.length;ad++){var S=H.buildingData[ad]["div"];var ag=H.buildingData[ad]["children"];var aa=ag.length*(H.option["roomheight"]+H.option["space"])+H.option["space"];var Y=w(ag,"children");var W=Y*(H.option["roomwidth"]+H.option["space"])+H.option["space"];var ai=H.buildingData[ad]["ground"]?H.buildingData[ad]["ground"]:0;var V=H.buildingData[ad]["store"]?H.buildingData[ad]["store"]:0;var R=ai*(H.option["roomheight"]+H.option["space"]);al+=(W);for(var ac=0;ac<ag.length;ac++){var ak=ag[ac]["children"];var Z=H.option["roomwidth"];if(ak.length==0){Z=W-H.option["space"]*2}else{if(ak.length!=Y){Z=Math.floor((W-H.option["space"])/ak.length-H.option["space"])}}var X=aa-(ac+1)*(H.option["space"]+H.option["roomheight"]);for(var ab=0;ab<ak.length;ab++){var ah=ak[ab]["div"];var U=[(ab*(Z+H.option["space"])+H.option["space"]),X];ak[ab]["bounce"]={"x":U[0],"y":U[1],"w":Z,"h":H.option["roomheight"]};ah.css({"position":"absolute","left":ak[ab]["bounce"].x+"px","top":ak[ab]["bounce"].y+"px","width":ak[ab]["bounce"].w+"px","height":ak[ab]["bounce"].h+"px"});ah.find(">div").height(ah.height())}var p=ag[ac]["div"];p.css({"left":H.option["space"]+"px","top":X+"px","width":(W-H.option["space"]*2-(ak.length==0?2:0))+"px","height":(H.option["roomheight"]-(ak.length==0?2:0))+"px"})}H.buildingData[ad]["bounce"]={"x":af,"y":(ae-aa+R),"w":W,"h":aa};S.css({"position":"absolute","left":H.buildingData[ad]["bounce"].x+"px","top":H.buildingData[ad]["bounce"].y+"px","width":H.buildingData[ad]["bounce"].w+"px","height":H.buildingData[ad]["bounce"].h+"px"});af+=(W)}for(var ad=0;ad<H.buildingData.length;ad++){var ag=H.buildingData[ad]["children"];for(var ac=0;ac<ag.length;ac++){var ak=ag[ac]["children"];for(var ab=0;ab<ak.length;ab++){var ah=ak[ab]["div"];var T=ak[ab]["merge"];(T&&T.length)?B(ah,T):null}}}var aj=a.find(".bd_groundColor");aj.css({"top":(-H.option["space"])+"px","bottom":(-J*(H.option["space"]+H.option["roomheight"])-H.option["space"])+"px"});a.height(ae).width(al)};this.resetAction=function(){$(H).trigger("RESET_ACTION",{"rooms":a.find(".bd_room"),"floors":a.find(".bd_floor")});if(H.isMergeing){H.setMerge(true)}if(H.isEdit){H.setEdit(true)}};this.setEdit=function(p){H.isEdit=p;if(p){a.find("h1.bd_roomname").on("dblclick",A);a.find(".bd_danyuantitle p").on("dblclick",L)}else{a.find("h1.bd_roomname").off("dblclick",A);a.find(".bd_danyuantitle p").off("dblclick",L)}};this.setMerge=function(p){if(p){H.isMergeing=true;x.Enabled=false;a.find(".bd_room").unbind("mousedown",t).bind("mousedown",t)}else{H.isMergeing=false;x.Enabled=true;a.find(".bd_room").unbind("mousedown",t)}};this.enableDrag=function(p){(x)?x.Enabled=p:null};function Q(){var S=$(this);var R=S.attr("data-group");if(R){var p=C.find("[data-group='"+R+"']");p.addClass("bd_group");S.one("mouseleave",function(){p.removeClass("bd_group")})}}this.addRoom=function(T,p){var U=H.buildingData[T]["children"][p]["children"];if(k(U)){$.alert("楼层有合并房间时不能增加房间。");return}var S={"id":y,"guid":"","groupid":"","olddata":false};U.push(S);var R=b(H.buildingData,T,p,U.length-1);S.name=R;S.rid=R;y++;N(T,p);H.refreshBuilding()};this.deleteRoom=function(T,p,S){var U=H.buildingData[T]["children"][p]["children"];if(k(U)){$.alert("楼层有合并房间时不能删除房间。");return}if(U[S]["olddata"]==true){K.push(U[S])}U.splice(S,1);N(T,p);H.refreshBuilding()};this.addFloor=function(p,Y){var S=H.buildingData[p]["children"][Y]["children"];if(k(S)){$.alert("楼层有合并房间时不能复制。");return}var U=H.buildingData[p]["children"][Y]["children"].length;var V={"children":[]};Y=(Y||Y==0)?Y:H.buildingData[p]["children"].length-1;var Z=H.buildingData[p]["ground"];var aa=H.buildingData[p]["store"];if(Y<Z){if(Y==0){H.buildingData[p]["children"].unshift(V)}else{H.buildingData[p]["children"].splice(Y-1,0,V)}Y++;H.buildingData[p]["ground"]++}else{H.buildingData[p]["children"].splice(Y+1,0,V);if(Y<Z+aa){H.buildingData[p]["store"]++}}for(var X=0;X<U;X++){var W={"id":"","name":"","guid":"","groupid":"","status":"new"};V.children.push(W);W.id=y;var T=H.buildingData[p]["children"][Y]["children"][X].name;W.rid=T;W.name=T;y++}N(p);H.refreshBuilding()};this.deleteFloor=function(R,p){if(H.buildingData[R]["children"].length==1){$.alert("单元至少保留一个楼层。");return}var S=H.buildingData[R]["children"][p]["children"];if(k(S)){$.alert("楼层有合并房间时不能删除楼层。");return}K=K.concat(S);if(H.buildingData[R]["ground"]&&H.buildingData[R]["ground"]>p){H.buildingData[R]["ground"]--}H.buildingData[R]["children"].splice(p,1);N(R);H.refreshBuilding()};this.addpart=function(Y){var S=H.buildingData[Y];
var X={"children":[]};H.buildingData.splice(Y+1,0,X);X["ground"]=S["ground"];X["store"]=S["store"];for(var U=0;U<S["children"].length;U++){var p={"children":[]};for(var T=0;T<S["children"][U]["children"].length;T++){var W={"id":y,"guid":"","groupid":"","status":"new"};var V=b(H.buildingData,Y,U,T);W.name=V;W.rid=V;p.children.push(W);y++}X.children.push(p)}N();H.refreshBuilding()};this.deletePart=function(S){if(H.buildingData.length==1){$.alert("建筑至少需要保留一个单元。");return}var R=H.buildingData[S]["children"];for(var p=0;p<R.length;p++){K=K.concat(R[p]["children"])}H.buildingData.splice(S,1);N();H.refreshBuilding()};this.setStoreNum=function(R,p){H.buildingData[p]["store"]=H.buildingData[p]["store"]?H.buildingData[p]["store"]:0;R?H.buildingData[p]["store"]++:H.buildingData[p]["store"]--;H.buildingData[p]["store"]=H.buildingData[p]["store"]<0?0:H.buildingData[p]["store"];H.buildingData[p]["store"]=H.buildingData[p]["store"]>(H.buildingData[p]["children"].length-H.buildingData[p]["ground"])?(H.buildingData[p]["children"].length-H.buildingData[p]["ground"]):H.buildingData[p]["store"];H.refreshBuilding()};this.setGroundNum=function(R,p){H.buildingData[p]["ground"]=H.buildingData[p]["ground"]?H.buildingData[p]["ground"]:0;R?H.buildingData[p]["ground"]++:H.buildingData[p]["ground"]--;H.buildingData[p]["ground"]=H.buildingData[p]["ground"]<0?0:H.buildingData[p]["ground"];H.buildingData[p]["ground"]=H.buildingData[p]["ground"]>(H.buildingData[p]["children"].length)?(H.buildingData[p]["children"].length):H.buildingData[p]["ground"];N(p);H.refreshBuilding()};function N(p,Z,W){if(p){if(Z){if(W){var S=H.buildingData[p]["children"][Z]["children"][W];(S["olddata"]==true)?S["update"]=true:null}else{var T=H.buildingData[p]["children"][Z]["children"];for(var X=0;X<T.length;X++){(T[X]["olddata"]==true)?T[X]["update"]=true:null}}}else{var Y=H.buildingData[p]["children"];for(var U=0;U<Y.length;U++){var T=Y[U]["children"];for(var X=0;X<T.length;X++){(T[X]["olddata"]==true)?T[X]["update"]=true:null}}}}else{for(var V=0;V<H.buildingData.length;V++){var Y=H.buildingData[V]["children"];for(var U=0;U<Y.length;U++){var T=Y[U]["children"];for(var X=0;X<T.length;X++){(T[X]["olddata"]==true)?T[X]["update"]=true:null}}}}}function k(R){for(var p=0;p<R.length;p++){if(R[p]["merge"]&&R[p]["merge"].length>0){return true;break}}return false}function B(U,R){if(!R||R.length==0){return}for(var S=0;S<R.length;S++){var T=C.find("#"+R[S]);if(T.length>0){var p=G(U,T);n(U,T,p,true)}}}function G(R,p){if(Math.abs(R.data("L")-p.data("L"))>1||(Math.abs(R.data("L")-p.data("L"))==0&&Math.abs(R.data("R")-p.data("R"))>1)){return"faraway"}if(R.data("L")>p.data("L")){return"down"}if(R.data("L")<p.data("L")){return"up"}if(R.data("R")>p.data("R")){return"left"}if(R.data("R")<p.data("R")){return"right"}}function t(){if(!H.isMergeing){return}var U=$(this);U.addClass("bd_mergeobj");var T=[];var S=g(U,"left");var R=g(U,"right");var p=g(U,"up");var V=g(U,"down");S?S.addClass("bd_preparemerge").attr("rev","left").one("mouseup",function(){v(U,$(this))}):null;R?R.addClass("bd_preparemerge").attr("rev","right").one("mouseup",function(){v(U,$(this))}):null;if(p){$.each(p,function(W){p[W]?p[W].addClass("bd_preparemerge").attr("rev","up").one("mouseup",function(){v(U,$(this))}):null})}if(V){$.each(V,function(W){V[W]?V[W].addClass("bd_preparemerge").attr("rev","down").one("mouseup",function(){v(U,$(this))}):null})}$(document).one("mouseup",function(){$(".bd_preparemerge").unbind("mouseup").removeClass("bd_preparemerge").attr("rev","");$(".bd_mergeobj").removeClass("bd_mergeobj")})}function v(V,T){if(!T.hasClass("bd_preparemerge")){return}var U=V.attr("rel")||"";var p=T.attr("rel")||"";var S=U?U:(p?p:V.attr("id"));V.attr("rel",S);T.attr("rel",S);var R=T.attr("rev");n(V,T,R)}function f(R,p){return s(R.attr("id"),p.attr("id"))}function s(R,S){var p=C.find("#"+R+"-"+S+",#"+S+"-"+R);if(p.length>0){return p}return null}function q(X,W){var T=j(X);var p=j(W);var U=true;if(T["merge"]){for(var V=T["merge"].length-1;V>=0;V--){if(T["merge"][V]==p.id){T["merge"].splice(V,1)}}if(T["merge"].length==0){T["name"]=T["rid"];X.removeAttr("data-group").find(">.bd_roomcont").show();T["groupid"]="";(T["olddata"]==true)?T["update"]=true:null;z(X,T);if(p["groupid"]==T["id"]){var Y=a.find("div[data-group="+p["groupid"]+"]");if(Y.length>0){I(Y,true)}}U=false}else{var Y=a.find("div[data-group="+T["groupid"]+"]");d(Y)}}if(p["merge"]){for(var V=p["merge"].length-1;V>=0;V--){if(p["merge"][V]==T.id){p["merge"].splice(V,1)}}if(p["merge"].length==0){p["name"]=p["rid"];W.removeAttr("data-group").find(">.bd_roomcont").show();p["groupid"]="";(T["olddata"]==true)?T["update"]=true:null;z(W,p);if(T["groupid"]==p["id"]){var Y=a.find("div[data-group="+T["groupid"]+"]");if(Y.length>0){I(Y,true)}}U=false}else{var Y=a.find("div[data-group="+p["groupid"]+"]");d(Y)}}if(!U){return}var S=p["groupid"];var R=E(S);if(R){I(R[0],true);I(R[1],true)}}function E(V){var T=C.find("div[data-group='"+V+"']");T.addClass("bd_checkgroup");var R=C.find(".bd_danyuan:eq("+T.eq(0).data("D")+")");
var W=[];var S=function(Z){for(var X=T.length-1;X>=0;X--){if(f($(T[X]),$(Z))){var Y=T[X];$(Y).removeClass("bd_checkgroup").addClass("bd_checkedgroup");W.push(Y);T.splice(X,1);S(Y)}}};var U=T[0];$(U).removeClass("bd_checkgroup").addClass("bd_checkedgroup");W.push(U);T.splice(0,1);S(U);var p;if(T.length>0){p=[R.find(".bd_checkgroup"),R.find(".bd_checkedgroup")]}R.find(".bd_checkgroup,.bd_checkedgroup").removeClass("bd_checkedgroup").removeClass("bd_checkgroup");return p}function M(V,T){var U=j(V);var R=j(T);U["merge"]?U["merge"].push(R.id):U["merge"]=[R.id];R["merge"]?R["merge"].push(U.id):R["merge"]=[U.id];var p;var S=C.find(".bd_danyuan:eq("+V.data("D")+")");if(U["groupid"]&&R["groupid"]){if(U["groupid"]!=R["groupid"]){p=S.find("[data-group='"+U["groupid"]+"'],[data-group='"+R["groupid"]+"']")}else{return}}else{if(U["groupid"]){p=S.find("[data-group='"+U["groupid"]+"'],#"+R["id"])}else{if(R["groupid"]){p=S.find("[data-group='"+R["groupid"]+"'],#"+U["id"])}else{p=S.find("#"+R["id"]+",#"+U["id"])}}}I(p)}function I(p,V){var S=o(p);var U=j(S);var T=V?U["id"]:U["groupid"]||U["id"];var R=U["rid"];p.each(function(){var W=j($(this));W["groupid"]=T;W["name"]=R;(W["olddata"]==true)?W["update"]=true:null;z($(this),W);$(this).attr("data-group",T)});d(p)}function d(p){var R=o(p);p.each(function(){$(this).find(">.bd_roomcont").hide()});R.find(">.bd_roomcont").show()}function o(p){var R=p.eq(0);p.each(function(){var S=$(this);if((S.data("L")<R.data("L"))||(S.data("L")==R.data("L")&&S.data("R")<R.data("R"))){R=S}});return R}function r(R){if(!R){return null}for(var T=0;T<H.buildingData.length;T++){for(var p=0;p<H.buildingData[T]["children"].length;p++){for(var S=0;S<H.buildingData[T]["children"][p]["children"].length;S++){if(H.buildingData[T]["children"][p]["children"][S]["groupid"]==R){H.buildingData[T]["children"][p]["children"][S]["div"].attr("data-group",R)}}}}return C.find("div[data-group='"+R+"']")}function n(Y,U,p,S){var W=f(Y,U);if(W&&!S){W.remove();q(Y,U);return}if(p=="faraway"){return}var Z=Y.attr("id")+"-"+U.attr("id");var T={"x":Y.position().left,"y":Y.position().top,"w":Y.outerWidth(),"h":Y.outerHeight()};var V={"x":U.position().left,"y":U.position().top,"w":U.outerWidth(),"h":U.outerHeight()};var aa;if(W){aa=W}else{aa=$('<div id="'+Z+'" class="bd_roomspace"></div>');aa.css({"position":"absolute"});Y.after(aa)}switch(p){case"left":var R=(V.x+V.w)+"px";aa.css({"width":H.option["space"]+"px","height":H.option["roomheight"]+"px","left":R,"top":T.y+"px"});break;case"right":var R=(V.x-H.option["space"])+"px";aa.css({"width":H.option["space"]+"px","height":H.option["roomheight"]+"px","left":R,"top":T.y+"px"});break;case"up":var R=Math.max(T.x,V.x)+"px";var X=Math.min(T.x+T.w,V.x+V.w)-Math.max(T.x,V.x);aa.css({"width":X,"height":H.option["space"]+"px","left":R,"top":(T.y-H.option["space"])+"px"});break;case"down":var R=Math.max(T.x,V.x)+"px";var X=Math.min(T.x+T.w,V.x+V.w)-Math.max(T.x,V.x);aa.css({"width":X,"height":H.option["space"]+"px","left":R,"top":(V.y-H.option["space"])+"px"});break}if(!S){M(Y,U)}}function j(p){return H.buildingData[p.data("D")]["children"][p.data("L")]["children"][p.data("R")]}function e(R){for(var T=0;T<H.buildingData.length;T++){for(var p=0;p<H.buildingData[T]["children"].length;p++){for(var S=0;S<H.buildingData[T]["children"][p]["children"].length;S++){if(H.buildingData[T]["children"][p]["children"][S]["id"]==R){return H.buildingData[T]["children"][p]["children"][S];break}}}}return null}this.getGroupData=function(R){if(!R){return[]}var T=[];for(var U=0;U<H.buildingData.length;U++){for(var p=0;p<H.buildingData[U]["children"].length;p++){for(var S=0;S<H.buildingData[U]["children"][p]["children"].length;S++){if(H.buildingData[U]["children"][p]["children"][S]["groupid"]==R){T.push(H.buildingData[U]["children"][p]["children"][S])}}}}return T};function P(T,p,R){if(T<0||R<0||p<0){return null}try{return H.buildingData[T]["children"][p]["children"][R]["div"]}catch(S){return null}}function g(W,S){var X=W.data("D");var p=W.data("L");var U=W.data("R");switch(S){case"left":U--;return P(X,p,U);break;case"right":U++;return P(X,p,U);break;case"up":p++;var T=W.position().left;var V=T+W.outerWidth();return F(X,p,T,V);break;case"down":p--;var T=W.position().left;var V=T+W.outerWidth();return F(X,p,T,V);break}return null}function F(R,X,T,aa){var Z;try{Z=H.buildingData[R]["children"][X]["children"]}catch(W){return null}if(!Z){return null}var S=[];for(var U=0;U<Z.length;U++){var p=P(R,X,U);if(p&&p.length>0){var Y=p.position().left;var V=Y+p.outerWidth();if((Y>=T&&Y<aa)||(V>T&&V<=aa)){S.push(p)}}}if(S.length>0){return S}return null}function w(S,p){var T=0;for(var R=0;R<S.length;R++){T=Math.max(S[R][p].length,T)}return T}function L(){if(!H.isEdit){return}var V=$(this);V.off("dblclick");var U=V.text();var R=$('<input type="text" value="'+U+'" maxlength="18"/>');var p=function(){if(!R){return}R.unbind().remove();var W=trim(R.val());W=W?W:U;R=null;V.text(W);h.unbind("mousedown",p);V.on("dblclick",L);var X=V.attr("rel");
H.buildingData[X]["name"]=W};var T=function(W){if(W.keyCode==13){p()}else{if(W.keyCode==27){if(!R){return}R.unbind().remove();R=null;V.text(U);V.on("dblclick",L)}}};var S=function(){V.empty().append(R);R.focus().bind("mousemove",function(W){W.stopPropagation()}).bind("mousedown",function(W){W.stopPropagation()}).bind("mousewheel",function(W){W.stopPropagation()}).one("blur",function(){p()});R.bind("keydown",T);h.one("mousedown",p)};S()}function A(){if(!H.isEdit){return}var S=$(this);S.off("dblclick");var W=S.parent().parent();var V=j(W);var p=$('<input name="roomname" type="text" value="'+V["name"]+'" style="width:100%;"/>');S.empty().append(p);var R=function(){if(!p){return}var X=trim(p.val())+"";if(X){V["name"]=V["rid"]=X;(V["olddata"]==true)?V["update"]=true:null;z(W,V);c(V["groupid"],X)}p.unbind().remove();p=null;h.unbind("mousedown",R);W.find("h1.bd_roomname").on("dblclick",A)};var U=function(){if(!p){return}p.unbind().remove();p=null;z(W,V);h.unbind("mousedown",R);W.find("h1.bd_roomname").on("dblclick",A)};var T=function(X){if(X.keyCode==13){R()}else{if(X.keyCode==27){U()}}};p.bind("keydown",T);h.one("mousedown",R);p.focus().bind("mousemove",function(X){X.stopPropagation()}).bind("mousedown",function(X){X.stopPropagation()}).bind("mousewheel",function(X){X.stopPropagation()})}function c(S,R){if(S==""){return}for(var V=0;V<H.buildingData.length;V++){for(var p=0;p<H.buildingData[V]["children"].length;p++){for(var T=0;T<H.buildingData[V]["children"][p]["children"].length;T++){if(H.buildingData[V]["children"][p]["children"][T]["groupid"]==S){H.buildingData[V]["children"][p]["children"][T]["name"]=R;(H.buildingData[V]["children"][p]["children"][T]["olddata"]==true)?H.buildingData[V]["children"][p]["children"][T]["update"]=true:null;var U=P(V,p,T);z(U,H.buildingData[V]["children"][p]["children"][T])}}}}}this.setSelected=function(S,R){var p=S.data("data");R=R?R:"bd_selected";a.find("."+R).removeClass(R);if(p["groupid"]){a.find("div[data-group='"+p["groupid"]+"']").addClass(R)}else{S.addClass(R)}};this.renameBuilding=function(){if(!H.isEdit){return}var S={};for(var X=0;X<H.buildingData.length;X++){var T=H.buildingData[X]["children"];for(var W=0;W<T.length;W++){var U=T[W]["children"];for(var V=0;V<U.length;V++){var R=b(H.buildingData,X,W,V);var p=H.buildingData[X]["children"][W]["children"][V];p["rid"]=R;(p["olddata"]==true)?p["update"]=true:null;if(p["groupid"]&&p["groupid"]!=""){var Y="g"+p["groupid"];if(!S[Y]){S[Y]=R}p["name"]=S[Y]}else{p["name"]=R}}}}H.refreshBuilding()};this.renewRoom=function(R,p){var S=R.data("data");$.extend(S,p);z(R,p)};function z(S,R){var p=$('<h1 class="bd_roomname">'+R["name"]+"</h1>");S.find(">.bd_roomcont").empty().append(p);var T=(typeof H.option["formatFun"]=="function")?H.option["formatFun"](R):null;!T?null:typeof T=="object"?S.find(">.bd_roomcont").append(T):typeof T=="string"?S.find(">.bd_roomcont").append($(T)):null}function b(U,Y,W,S){var ab=U[Y]["ground"]||0;var V=U[Y]["store"]||0;var p=(H.rules["danyuan"]=="english")?u.substr(Y,1):m((Y+1)+"",H.rules["partleng"]||0,"0");var Z=W-ab;var aa;if(Z<0){aa=H.rules["preunder"];Z=-Z}else{Z=Z+1;if(Z<=V){aa=H.rules["premenshi"]}else{aa=H.rules["pre"];Z=Z-(!H.rules["singlequn"]?0:V)}}Z=m(Z+"",H.rules["floorleng"]||0,"0");var X=m((S+1)+"",H.rules["roomleng"]||0,"0");var T=aa+p+H.rules["split"]+Z+H.rules["split"]+X+H.rules["end"];return T}function m(R,p,S){var T=R+"";if(T.length>=p){return T}while(T.length<p){T=S+T}return T}function w(S,p){var T=0;for(var R=0;R<S.length;R++){T=Math.max(S[R][p].length,T)}return T}this.getToDelete=function(){for(var p=K.length-1;p>=0;p--){delete K[p]["update"];delete K[p]["id"];delete K[p]["groupid"];if(K["olddata"]==false){K.split(p,1)}}return K};this.creatNewBuildingData=function(U,S,ac){if(!U){return}var ab=1;var aa=[];var S=S?S:[];for(var Y=0;Y<U.length;Y++){var p={"name":(Y+1)+"","children":[],"ground":(S[Y]||0),"store":(ac[Y]||0)};aa.push(p);for(var W=0;W<U[Y].length;W++){var Z={"children":[]};p.children.push(Z);for(var V=0;V<U[Y][W];V++){var X={"id":ab,"guid":"","groupid":"","olddata":false};Z.children.push(X);var T=b(aa,Y,W,V);X.name=T;X.rid=T;ab++}}}return aa}};