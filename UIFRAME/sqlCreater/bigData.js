function RelationSearch(b){var c=this;var n;var i;var h=[];var q;var l;var j;var r;var e;var f;this.option={"pos":[450,150],"stepSpace":30,"inputWidth":125,"opteatSign":[{"label":"或者","value":"or"},{"label":"并且","value":"and"}],"linkSign":{"string":[{"label":"等于","value":"="},{"label":"象","value":"like"},{"label":"包含","value":"contain"}],"datetimesecond":[{"label":"介于","value":"between"}],"datetime":[{"label":"介于","value":"between"}],"date":[{"label":"介于","value":"between"}],"select":[{"label":"等于","value":"="}],"number":[{"label":"等于","value":"="},{"label":"大于","value":">"},{"label":"小于","value":"<"},{"label":"大于等于","value":">="},{"label":"小于等于","value":"<="}],"int":[{"label":"等于","value":"="},{"label":"大于","value":">"},{"label":"小于","value":"<"},{"label":"大于等于","value":">="},{"label":"小于等于","value":"<="}]},"datasource":{"name":"lvguany","label":"旅馆业数据","des":"旅馆业大数据"},"dataset":[]};this.destroy=function(){g();if(n){n.destroy();n=null}if(i){i.del();i=null}};function g(){for(var p=0;p<h.length;p++){h[p]["div"].del()}h.splice(0,h.length)}this.install=function(){i=$("<div></div>");i.css({"position":"absolute","top":c.option["pos"][1]+"px","left":c.option["pos"][0]+"px","overflow":"visible"});b.append(i);b.css({"position":"relative","overflow":"hidden"}).addClass("gridBackGround");n=new dragDivObj();n.holdTop=false;n.install(b,i,function(){return[b.offset().left,b.offset().top]});var p=$('<a class="bd_centerBut"><i class="fa fa-dot-circle-o "/></a>');b.append(p);p.css({"position":"absolute","bottom":"10px","left":"10px","z-index":5});p.bind("click",o)};function o(){var p=[Math.floor(b.width()/2),Math.floor(b.height()/2)];i.css({"top":Math.floor(p[1]-i.find(".bd_searchTitle").outerHeight()/2)+"px","left":(p[0]-Math.floor(q.outerWidth(true)/2))+"px"})}this.load=function(p){if(p){c.option["dataset"]=p}c.creat();e=c.creatCondition();var s=h[0]["div"];s.append(e);s.find("input[type=text],label").bind("mousedown",stopPP);o();c.resize()};this.creatCondition=function(){var w=$('<form class="bd_conditionForm"></form>');for(var v=0;v<c.option["dataset"].length;v++){var t="";var s=c.option["linkSign"][c.option["dataset"][v]["show"]];for(var u=0;u<s.length;u++){t+='<option value="'+s[u]["value"]+'">'+s[u]["label"]+"</option>"}var p="";switch(c.option["dataset"][v]["show"]){case"string":p='<input name="'+c.option["dataset"][v]["value"]+'" type="text"  style="width:'+c.option["inputWidth"]+'px" class="valueSign" maxlength="50"/>';break;case"int":case"number":p='<input name="'+c.option["dataset"][v]["value"]+'" type="text"  style="width:'+c.option["inputWidth"]+'px" class="valueSign" maxlength="50"/>';break;case"date":p='<input name="'+c.option["dataset"][v]["value"]+'" type="text"  style="width:'+c.option["inputWidth"]+"px\" class=\"valueSign fm_datepartinput\"  value=\"\"  data-option=\"{'data':'y,m,d','force2':true,'split':' 到 '}\" />";break;case"datetime":p='<input name="'+c.option["dataset"][v]["value"]+'" type="text"  style="width:'+c.option["inputWidth"]+"px\" class=\"valueSign fm_datepartinput\"  value=\"\"  data-option=\"{'data':'y,m,d,h,t','force2':true,'split':' 到 '}\"/>";case"datetimesecond":p='<input name="'+c.option["dataset"][v]["value"]+'" type="text"  style="width:'+c.option["inputWidth"]+"px\" class=\"valueSign fm_datepartinput\"  value=\"\"  data-option=\"{'data':'y,m,d,h,t,s','force2':true,'split':' 到 '}\"/>";break;case"select":p='<select name="'+c.option["dataset"][v]["value"]+'" class="valueSign" style="width:'+c.option["inputWidth"]+"px\" data-option=\"{'url':'"+c.option["dataset"][v]["url"]+"','mulit':true,'compact':true}\"></select>";break}var x=$('<div class="conditionItem" rel="'+c.option["dataset"][v]["type"]+'"  rev="'+c.option["dataset"][v]["show"]+'">'+'<span rel="'+c.option["dataset"][v]["value"]+'" class="conditionlabel" style="display:inline-block;">'+c.option["dataset"][v]["label"]+"</span>"+'<select class="fm_switchSelect linkSign '+c.option["dataset"][v]["show"]+'" style="width:57px" id="sign_'+c.option["dataset"][v]["value"]+'" data-option="{\'compact\':true}" name="rel_'+c.option["dataset"][v]["value"]+'"> '+t+" </select>"+p+"</div>");w.append(x)}conditionForm=new formDeal(w);$(conditionForm).one("HTML_BEFORE_FORMAT",function(z,y){f=y["formobj"].clone()});conditionForm.parse();return w};this.creat=function(){g();i.clear();q=$('<div class="bd_baseline"/>');i.append(q);q.css({"position":"relative","height":"4px","width":"0px;","background-color":"#333"});l=$('<div class="bd_bigIcon"><i class="fa fa-user"/></div>');q.append(l);l.css({"position":"absolute"});var p=$('<div class="bd_conditionWraper"></div>');q.append(p);p.css({"position":"absolute"});h.push({"div":p,"relation":null});j=$('<div class="bd_addLinkbut"><i class="fa fa-plus"/></div>');q.append(j);j.css({"position":"absolute"});r=$('<div class="bd_bigIcon"><i class="fa fa-search"/></div>');q.append(r);r.css({"position":"absolute"});j.bind("click",d);r.bind("click",function(){console.log(c.getSqlString())});var s=$('<div class="bd_searchTitle">'+'<input name="Description" type="text" id="Description2" value="'+(c.option["datasource"]["DataSourceLabel"]+"查询")+'" maxlength="40" style="width:300px;padding:5px;" />'+'<p><a  id="searchButton"  class="but-normal but-red"> <i class="fa fa-check"></i> 开始查询</a></p>'+"</div>");
i.append(s);s.find("input[type=text],#searchButton").bind("mousedown",stopPP);s.find("#searchButton").bind("click",function(){var u=c.getSqlString();var t=s.find("input[name=Description]").val();t=t||"未命名查询";if(u){$(c).trigger("START_SEARCH",{"where":u,"title":t})}else{$.alert("请检查查询条件")}});c.resize()};function d(){var u=h[h.length-1]["div"];var w=$('<div class="bd_relationbut" rel="or"><p>或者<span>OR</span></p></div>');u.after(w);w.css({"position":"absolute","left":u.css("left")});w.one("click",k);var t=$('<div class="bd_conditionWraper bd_addCondition"></div>');t.css({"position":"absolute","left":u.css("left")});u.after(t);var v="cd_"+(new Date()).getTime()+"_"+Math.floor(Math.random()*10000);h.push({"div":t,"relation":w,"id":v});var s=f.clone();t.empty().append(s);formatForm(s);var p=$('<a class="bd_removeBut"><i class="fa fa-remove"/></a>');t.append(p);p.css({"position":"absolute","bottom":-(p.outerWidth()+5)+"px","left":"48%"});p.data("dataid",v).one("click",a).bind("mousedown",stopPP);t.find("input[type=text],label").bind("mousedown",stopPP);c.resize()}function k(){var p=$(this);p.find(".bd_relationSelectBut").del();var t=$('<div class="bd_relationSelectBut"><p rel="and">并且<span>AND</span></p><p rel="or">或者<span>OR</span></p></div>');p.append(t);t.css({"position":"absolute","left":"0px","top":-Math.floor(t.outerHeight()/2-p.outerHeight()/2)+"px"});var s=function(){if(t){t.del();t=null}setTimeout(function(){p.one("click",k)},100)};p.one("mouseleave",s);t.find("p").one("click",function(){var u=$(this).attr("rel");p.attr("rel",u);var v=(u=="and")?"<p>并且<span>AND</span></p>":"<p>或者<span>OR</span></p>";p.html(v);s()})}function a(){var p=$(this);var t=p.data("dataid");for(var s=0;s<h.length;s++){if(h[s]["id"]==t){h[s]["div"].del();h[s]["relation"].del();h.splice(s,1);break}}c.resize()}this.getSqlString=function(){var u="";var w=h[0]["div"];var p=w.find("form").serializeJson();u+=m(p);if(h.length>1){for(var t=1;t<h.length;t++){var w=h[t]["div"];var p=w.find("form").serializeJson();var v=m(p);if(v){var s=h[t]["relation"];u+=(u?" "+s.attr("rel")+" ":"")+v}}}return u};function m(y){var z="";for(var u=0;u<c.option["dataset"].length;u++){var v=c.option["dataset"][u]["value"];y[v]=(y[v]=="loading..."||y[v]=="")?null:y[v];if(y[v]||y[v]==0){var t="";var s=y[v];var w=y["rel_"+v];switch(w){case"like":t+=" and "+v+" like ";t+=' "'+s+'%" ';break;case"contain":t+=" and "+v+" like ";t+=' "%'+s+'%" ';break;case"between":var p=s.split(" 到 ");var x=" ("+v+' >= "'+p[0]+'" and '+v+' <= "'+p[1]+'") ';t=" and "+x;break;default:if(s.indexOf(",")>0){if(c.option["dataset"][u]["show"]=="int"||c.option["dataset"][u]["show"]=="number"){s=" ("+s+") "}else{s=' ("'+s+'") ';s=s.replace(/\,/g,'","')}t+=" and "+v+" in "+s}else{t+=" and "+v+" "+w+" ";if(c.option["dataset"][u]["show"]=="int"||c.option["dataset"][u]["show"]=="number"){t+=" "+s+" "}else{t+=' "'+s+'" '}}break}z+=t}}z=(z.length>3)?z.replace(" and",""):"";return z?"("+z+")":""}this.resize=function(){var p=0;l.css({"left":Math.floor(-l.outerWidth()/2)+"px","top":Math.floor(-l.outerHeight()/2)+"px"});p+=l.outerWidth()/2+c.option["stepSpace"];var s=0;for(var u=0;u<h.length;u++){if(h[u]["relation"]){h[u]["relation"].css({"left":p+"px","top":Math.floor(-h[u]["relation"].outerHeight()/2)+"px"});p+=h[u]["relation"].outerWidth()+c.option["stepSpace"]}h[u]["div"].css({"left":p+"px","top":Math.floor(-h[u]["div"].outerHeight()/2)+"px"});p+=h[u]["div"].outerWidth()+c.option["stepSpace"];s=Math.max(s,h[u]["div"].outerHeight())}j.css({"left":p+"px","top":Math.floor(-j.outerHeight()/2)+"px"});p+=j.outerWidth()+c.option["stepSpace"];r.css({"left":p+"px","top":Math.floor(-r.outerHeight()/2)+"px"});p+=r.outerWidth()/2;q.css({"margin-left":Math.floor(l.outerWidth()/2)+"px","margin-right":Math.floor(r.outerWidth()/2)+"px","width":p+"px"});i.width(Math.floor(p));var t=i.find(".bd_searchTitle");t.css({"top":Math.floor(s/2+50)+"px","left":Math.floor(l.outerWidth()/2)+"px","margin-right":Math.floor(r.outerWidth()/2)+"px","width":p+"px"})};this.getRealSQL=function(){if(c.checkSQL()){return m(SqlBox.find(">a")).replace(/  /g," ")}return null};this.searchTitle=function(s){alert(s);if(s){alert(i.find("input[name=Description]").length);i.find("input[name=Description]").val(s);return}var p=i.find("input[name=Description]").val();p=p||"未命名查询";return p}};