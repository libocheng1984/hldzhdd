function SqlCreator(h){var l=this;var k;var s;var v;var b;var g;var e;var j;var c;var r;var i={"op":"SC_opreator","cn":"SC_condition","gr":"SC_group","ct_cn":"SC_condition_container","ct_gr":"SC_group_container"};this.option={"size":{"cc":470},"opteatSign":[{"label":"或者","value":"or"},{"label":"并且","value":"and"}],"linkSign":{"string":[{"label":"等于","value":"="},{"label":"象","value":"like"},{"label":"包含","value":"contain"}],"datetime":[{"label":"介于","value":"between"}],"date":[{"label":"介于","value":"between"}],"select":[{"label":"等于","value":"="}],"number":[{"label":"等于","value":"="},{"label":"大于","value":">"},{"label":"小于","value":"<"},{"label":"大于等于","value":">="},{"label":"小于等于","value":"<="}],"int":[{"label":"等于","value":"="},{"label":"大于","value":">"},{"label":"小于","value":"<"},{"label":"大于等于","value":">="},{"label":"小于等于","value":"<="}]},"datasource":{"name":"lvguany","label":"旅馆业数据","des":"旅馆业大数据"},"dataset":[]};this.destroy=function(){if(b){b.del();b=null}};this.install=function(){b=$('<div class="SqlWraper"><div class="SqlContainer"></div><div class="ConditionContainer"></div></div>');h.empty().append(b);var w=b.find(".SqlContainer");w.css({"overflow-x":"auto"});k=$('<div class="sqlBox"></div>');c=$('<div class="sqlShowBox"></div>');w.append(k).append(c);w.append($('<p class="tishi">首先在下方创建所需条件，将条件或逻辑关系拖入以上组合栏，生成检索条件。双击可删除。</p>'));var p=b.find(".ConditionContainer");p.css({"overflow":"hidden","position":"relative"});s=$('<div class="blockBox opreatorBox"></div>');s.css({"position":"absolute","top":"0px","overflow-y":"auto"});v=$('<div class="blockBox conditionBox"><div class="conditionList"></div><div class="cl"></div></div>');v.css({"position":"absolute","top":"0px","overflow-y":"auto"});e=$('<div class="blockBox conditionCreatBox"></div>');e.css({"position":"absolute","top":"0px","overflow-y":"auto"});p.append(s).append(v).append(e)};this.resize=function(){var x={"w":h.width(),"h":h.height()};b.css({"overflow":"hidden"}).setRealSize(x.w,x.h);x={"w":b.width(),"h":b.height()};var z=b.find(".SqlContainer");var p=b.find(".ConditionContainer");var y=x.h-z.outerHeight(true);p.setRealSize(x.w,y);var w=p.height();e.setRealSize(l.option["size"]["cc"],w);e.css({"left":"0px"});l.option["size"]["cn"]=p.width()-e.outerWidth(true);s.setRealSize(l.option["size"]["cn"],null);s.css({"top":"0px","right":"0px"});var A=s.outerHeight(true);w-=A;v.setRealSize(l.option["size"]["cn"],w);v.css({"right":"0px","top":A+"px"})};this.load=function(p){if(p){l.option["dataset"]=p}l.creat();l.creatCondition();l.resize()};this.creatCondition=function(){e.empty();for(var z=0;z<l.option["dataset"].length;z++){var x="";var w=l.option["linkSign"][l.option["dataset"][z]["show"]];for(var y=0;y<w.length;y++){x+='<option value="'+w[y]["value"]+'">'+w[y]["label"]+"</option>"}var p="";switch(l.option["dataset"][z]["show"]){case"string":p='<input name="'+l.option["dataset"][z]["value"]+'" type="text"  style="width:160px" class="valueSign" maxlength="50"/>';break;case"int":case"number":p='<input name="'+l.option["dataset"][z]["value"]+'" type="text"  style="width:160px" class="valueSign" maxlength="50"/>';break;case"date":p='<input name="'+l.option["dataset"][z]["value"]+'" type="text"  style="width:160px" class="valueSign fm_datepartinput"  value=""  data-option="{\'data\':\'y,m,d\',\'force2\':true,\'split\':\' 到 \'}" />';break;case"datetime":p='<input name="'+l.option["dataset"][z]["value"]+'" type="text"  style="width:160px" class="valueSign fm_datepartinput"  value=""  data-option="{\'data\':\'y,m,d,h,t\',\'force2\':true,\'split\':\' 到 \'}"/>';break;case"select":p='<select name="'+l.option["dataset"][z]["value"]+'" class="valueSign" style="width:160px" data-option="{\'url\':\''+l.option["dataset"][z]["url"]+"','mulit':true}\"></select>";break}var A=$('<div class="conditionItem" rel="'+l.option["dataset"][z]["type"]+'"  rev="'+l.option["dataset"][z]["show"]+'"><span rel="'+l.option["dataset"][z]["value"]+'" class="label">'+l.option["dataset"][z]["label"]+'</span> <select class="linkSign '+l.option["dataset"][z]["show"]+'" style="width:80px" id="sign_'+l.option["dataset"][z]["value"]+'"> '+x+" </select>"+p+"<a>创建 + </a></div>");e.append(A)}j=new formDeal(e);$(j).one("HTML_FORMATED",q);j.parse();e.find("a").bind("click",m)};function q(){}function m(){var F=$(this).parent();var x=trim(F.find(".valueSign").val());if(!x){return}x=formatSqlStr(x);var B=F.attr("rel");var w=F.attr("rev");var y="";var z="";y+=F.find("span").attr("rel");var D=F.find(".linkSign").val();var A=F.find(".linkSign").getText();z+=F.find("span").text();if(w=="select"){var H=trim(F.find(".valueSign").getText());if(x.indexOf(",")>0){D=" in ";A=" 可能是 ";H="("+H+")";if(B=="string"){x=' ("'+x+'") ';x=x.replace(/\,/g,'","')}else{x=" ("+x+") "}}else{if(B=="string"){x=' "'+x+'" '}}z+="<i>"+A+"</i>";z+=H;y+=D;y+=x}else{z+="<i>"+A+"</i>";z+=x;if(B=="string"){switch(D){case"like":y+=" "+D+" ";y+=' "'+x+'%" ';break;case"contain":y+=" like ";y+=' "%'+x+'%" ';break;case"between":var p=x.split(" 到 ");
var G=y+'>="'+p[0]+'" and '+y+'<="'+p[1]+'"';y=G;break;default:y+=" "+D+" ";y+=' "'+x+'" ';break}}else{y+=" "+D+" ";y+=x}}var C=false;v.find(".conditionList .conditionPart").each(function(){if($(this).data("relval")==y){C=true;return false}});if(C){$.message("条件已存在，不要重复创建",2000);return}var E=$('<a  class="'+i["cn"]+' conditionPart" draggable="true"   href="javaScript:void(0)"><strong></strong></a>');E.find("strong").html(z);E.data("relval",y).attr("title",y);v.find(".conditionList").append(E);v.find("a").unbind().bind("dragstart",function(I){k.find(".candrop").removeClass("candrop");g=$(this);k.find("a span."+i["ct_cn"]).addClass("candrop");k.find("a."+i["cn"]).addClass("candrop");k.find("a span."+i["ct_gr"]).addClass("candrop")}).bind("dblclick",function(){$(this).del()}).bind("click",function(I){stopPP(I);I.preventDefault()})}this.creat=function(){v.find(".conditionList").empty();s.empty();k.empty();c.empty();for(var w=0;w<l.option["opteatSign"].length;w++){var p=$('<a class="'+i["op"]+'" draggable="true"  id="opreator_'+w+'" href="javaScript:void(0)"><span class="'+i["ct_cn"]+'"></span><strong> '+l.option["opteatSign"][w]["label"]+' </strong><span class="'+i["ct_cn"]+'"></span></a>');p.data("relval",l.option["opteatSign"][w]["value"]).attr("title",l.option["opteatSign"][w]["value"]);s.append(p)}var p=$('<a class="'+i["gr"]+'" draggable="true" href="javaScript:void(0)"><strong>( </strong><span class="'+i["ct_gr"]+' display"></span><strong> )</strong></a>');p.data("relval","()").attr("title","()");s.append(p);var x=$('<a class="rootContainer '+i["gr"]+'" draggable="false"><strong>( </strong><span class="'+i["ct_gr"]+'"></span><strong>  )</strong></a>');k.append(x);x.data("relval","()").attr("title","()");a()};function a(){s.find("a."+i["op"]).bind("dragstart",function(p){k.find(".candrop").removeClass("candrop");g=$(this);k.find("a span."+i["ct_gr"]).addClass("candrop");k.find("a."+i["cn"]).addClass("candrop")}).bind("click",function(p){stopPP(p);p.preventDefault()});s.find("a."+i["gr"]).bind("dragstart",function(p){k.find(".candrop").removeClass("candrop");g=$(this);k.find("a span."+i["ct_cn"]).addClass("candrop");k.find("a."+i["cn"]).addClass("candrop")}).bind("click",function(p){stopPP(p);p.preventDefault()});b.unbind("drop").bind("drop",function(p){k.find(".candrop").removeClass("candrop");stopPP(p);p.preventDefault()}).bind("dragover",function(p){p.preventDefault()});d()}function d(){k.find("*").unbind().bind("drop",function(p){stopPP(p);p.preventDefault()});k.find("a span").unbind().bind("drop",n).bind("dragover",function(p){p.preventDefault()});k.find("a."+i["cn"]).unbind().bind("drop",n).bind("dragover",function(p){p.preventDefault()});k.find("a").bind("dblclick",f).bind("click",function(p){stopPP(p);p.preventDefault()});k.find("a."+i["cn"]+" *").unbind()}function f(w){if($(this).hasClass("rootContainer")){return}var p=$("<span></span>");if($(this).hasClass(i["cn"])){p.addClass(i["ct_cn"])}else{if($(this).hasClass(i["gr"])){p.addClass(i["ct_gr"])}else{if($(this).hasClass(i["op"])){p.addClass(i["ct_gr"])}}}$(this).after(p).del();d();t();stopPP(w);w.preventDefault()}this.getRealSQL=function(){if(l.checkSQL()){return o(k.find(">a")).replace(/  /g," ")}return null};function t(){var p=o(k.find(">a"));c.html(p)}this.checkSQL=function(){var p=k.find("."+i["ct_cn"]+":empty,."+i["ct_gr"]+":empty").length;return p>0?false:true};function o(p){var w="";p.each(function(){var x=$(this).data("relval");if(x=="()"){w+=" ( "+o($(this).find(">a"))+" ) "}else{if(x=="or"||x=="and"){w+=o($(this).find(">a:eq(0)"))+" "+x+" "+o($(this).find(">a:eq(1)"))}else{w+=x+o($(this).find(">a"))}}});return w}function n(w){if(!g){return}var x=$(this);if(!x.hasClass("candrop")){return}var p=g.clone();p.attr("draggable",false);p.data("relval",g.data("relval"));u(p,x);g=null;k.find(".candrop").removeClass("candrop");d();t();stopPP(w);w.preventDefault()}function u(p,w){if(w.hasClass(i["cn"])){if(p.hasClass(i["op"])){w.after(p);p.find("span:eq(0)").after(w).remove()}else{if(p.hasClass(i["gr"])){w.after(p);p.find("span."+i["ct_gr"]).after(w).remove()}else{if(p.hasClass(i["cn"])){w.after(p).remove()}}}}else{w.after(p).remove()}}};