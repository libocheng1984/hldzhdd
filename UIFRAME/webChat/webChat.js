var FrameVersion="20169.29.1132";function webChat(O){var G=this;this.onshow=false;this.chatOn;this.option={height:0.8,minheight:300,groupwidth:280,chatminwidth:300,chatwidth:300,userwidth:200,infowidth:240,maxmsg:200,listener:"http",timer:10000,sound:true,infotitle:"\u8b66\u60c5"};var i=ZINDEX.pop;var t=ZINDEX.popActive;var K=ZINDEX.popLockMask;var A=ZINDEX.frontClass;var b;var c;var J;var B;var r;var w;var l;var D;var o=navigator.userAgent.indexOf("MSIE 8.0")>0?true:false;var h={};var m=false;var k=false;this.install=function(){$.extend(G.option,O);if(!G.option.hostPort){return}G.option.height=G.option.height<1?Math.floor(G.option.height*$(window).height()):G.option.height;G.option.height=G.option.height>$(window).height()-20?$(window).height()-20:G.option.height;G.option.height=G.option.minheight<G.option.height?G.option.height:G.option.minheight;b={width:G.option.groupwidth,groupwidth:G.option.groupwidth,chatwidth:0,userwidth:0,infowidth:0};var R=Math.floor(($(window).height()-G.option.height)/2);R=R<0?0:R;var S=Math.floor(($(window).width()-G.option.groupwidth)/2);S=S<0?0:S;c=$('<div id="webChatBox"><div class="chatTitleBox">'+G.option.title+'<span><i class="fa fa-remove"></i></span></div><div class="chatGroupWraper"><div class="chatMainMenuBox"><a id="chatbut_creat" title="\u65b0\u5efa"><i class="fa fa-plus"></i></a><a id="chatbut_reload" title="\u5237\u65b0"><i class="fa fa-refresh"></i></a>'+(G.option.historyBut?'<a id="chatbut_history" title="\u804a\u5929\u8bb0\u5f55"><i class="fa fa-history"></i></a>':"")+(G.option.listener=="socket_http"?'<a id="chatbut_connect" class="socketbut" title="\u8fde\u63a5"><i class="fa fa-wifi"></i></a>':"")+'<dd><input name="groupkey" placeholder="\u8f93\u5165\u7ec4\u540d\u67e5\u8be2"/></dd></div><div class="chatGroupContainer"><ul class="chat_listTemp"><li  dir="ltr"><h1><span class="newmsg">0</span><span id="groupname"></span></h1><p id="lastmsg"></p></li></ul></div></div><div class="chatWindowWraper"><div class="chatMainMenuBox"><p><a id="chatbut_close" title="\u5173\u95ed"><i class="fa fa-chevron-left "></i></a><a id="chatbut_info" title="'+G.option.infotitle+'"><i class="fa fa-exclamation-triangle"></i></a><a id="chatbut_user" title="\u4eba\u5458"><i class="fa fa-users"></i></a></p><span id="chat_groupname"></span></div><div class="chatWindowContainer"><div class="chatMsgBox"><div class="chatMsgContainer"></div><div class="chatSendBox chatfixfoot"></div></div><div class="chatUserListBox"><div class="chatUserListContainer"></div><div class="chatFootMenuBox chatfixfoot"><a id="chatbut_add" title="\u52a0\u4eba"><i class="fa fa-user-plus"></i></a><a id="chatbut_remove" title="\u5220\u9664"><i class="fa fa-user-times"></i></a><a id="chatbut_quit" title="\u9000\u51fa"><i class="fa fa-sign-out"></i></a></div></div>'+(G.option.detailTemplete?'<div class="chatInfoBox"><div class="chatInfoContainer"></div><div class="chatFootMenuBox chatfixfoot"><a id="chatbut_reloadinfo" title="\u5237\u65b0"><i class="fa fa-refresh"></i></a><a id="chatbut_detail" title="\u67e5\u770b"><i class="fa fa-file-text"></i></a></div></div>':"")+'<div class="cl"></div></div></div><div class="cl"></div></div>');$("body").append(c);h.groupWraper=c.find(".chatGroupWraper");h.groupContainer=c.find(".chatGroupContainer");h.chatWraper=c.find(".chatWindowWraper");h.chatContainer=h.chatWraper.find(".chatWindowContainer");h.chatbox=h.chatContainer.find(".chatMsgBox");h.userbox=h.chatContainer.find(".chatUserListBox");h.infobox=G.option.detailTemplete?h.chatContainer.find(".chatInfoBox"):null;h.menuH=36;h.footH=33;h.sendH=36;h.groupWraper.css({"float":"left",width:G.option.groupwidth+"px"});h.chatWraper.css({"float":"right"});h.chatbox.css({position:"relative","float":"left"});h.userbox.css({position:"relative","float":"left"}).hide();h.infobox?h.infobox.css({position:"relative","float":"right","overflow-x":"hidden","overflow-y":"hidden"}).hide():null;h.groupContainer.css({"overflow-x":"hidden","overflow-y":"auto"});h.groupContainer.find("ul.chat_listTemp").attr("dir","ltr");c.css({position:"fixed",top:R+"px",left:S+"px","min-height":G.option.minheight,"max-height":G.option.maxheight,"z-index":i});c.find(".chatfixfoot").css({position:"absolute",bottom:"0px",left:"0px",right:"0px"});h.chatWraper.hide();G.onshow=false;var T=$('<div class="dragSizeBox"><a></a></div>');c.append(T);T.css({position:"relative",height:"0px",overflow:"visible"}).find("a").css({position:"absolute",top:"-10px",right:"-10px",width:"20px",height:"20px",cursor:"nw-resize"});resizeDrag=new dragWindowSize(T.find(">a"),c);$(resizeDrag).bind("DRAG_RESIZE",G.resize);c.find(".chatMainMenuBox a,.chatFootMenuBox a").bind("click",L);c.find(".chatTitleBox").bind("mousedown",u);c.find(".chatTitleBox span").bind("click",G.hideChat);c.find("input[name=groupkey]").bind("change",E);c.bind("mousedown",G.toFront);if(G.option.detailPort){l=new chatInfoDetail(c.find(".chatInfoContainer"),G.option.detailPort,G.option.detailTemplete);l.install()}w=new ListView(c.find(".chatGroupContainer ul.chat_listTemp"));
w.option.classStyle["checked"]="nowid";w.option.enableCheck=true;$(w).unbind("LI_CLICKED").bind("LI_CLICKED",function(W,V){var U=V.data["groupid"];G.openGroup(U,true)});var Q=function(U){U.lastmsg=U.lastmsg?U.lastmsg:"";U.lastmsg=U.jingqing?'[ <a rel="'+U.jingqing+'" class="showJingqing red" title="'+U.jingqing+'">'+G.option.infotitle+" "+U.jingqing.substr(U.jingqing.length-4,U.jingqing.length)+"</a>  ]"+U.lastmsg:"... "+U.lastmsg;return U};var p=function(U){U.RightPopMenu(function(){return P(U.data("data"))});U.find("a.showJingqing").bind("click",function(){var V=$(this).attr("rel");$(G).trigger("CHAT_ADDINFO",{jingqing:V});return false})};q();c.hide();G.chatOn=false;if(G.option.alarmSound){D=GLOBALSOUND?GLOBALSOUND:new SoundPlayer(G.option.alarmSound)}w.load(G.option.groupPort,creatPostParam("getGroupList"),Q,p);B=new ChatBox(c.find(".chatMsgContainer"),c.find(".chatUserListContainer"));B.maxmsg=G.option.maxmsg;$(B).bind("CREAT_GROUP",s).bind("DELETE_GROUP",g).bind("OPEN_GROUP",C).bind("CHANGE_GROUP",d).bind("CHAT_VOICE",function(V,U){$(G).trigger("CHAT_VOICE",U)}).bind("CHAT_VIDEO",function(V,U){$(G).trigger("CHAT_VIDEO",U)});r=new ChatInput(c.find(".chatSendBox"));r.uploadUrl=G.option.uploadurl;$(r).bind("SEND_MSG",function(V,U){G.sendMsg(U.msg,U.add)}).bind("ERROR",function(U,V){e(V.msg,2000)}).bind("UPLOAD_START",function(){$.loading(300000)}).bind("UPLOAD_END",function(){$.loaded()});J=new ChatCore(G.option);$(J).bind("ERROR",function(U,V){e(V.msg,2000)}).bind("GOT_MESSAGE",function(V,U){G.gotMsg(U.msg)}).bind("GOT_USERLIST",function(V,U){G.gotList(U.list)}).bind("GOT_GROUP",function(V,U){G.gotGroup(U.groups)}).bind("UPDATE_GROUPNAME",x).bind("GET_MESSAGE_FAIL",function(){e("\u8bfb\u53d6\u6d88\u606f\u5931\u8d25",2000)}).bind("SOCKET_CONNECTED",function(){c.find(".chatMainMenuBox a#chatbut_connect").addClass("online");if(typeof G.option.shakeHandFun=="function"){var V=G.option.shakeHandFun();V=typeof V=="object"?JSON.stringify(V):V;var U=V.length+"";while(U.length<5){U="0"+U}V=U+V;J.sendBySocket(V)}}).bind("SOCKET_CONNECT_FAIL",function(){c.find(".chatMainMenuBox a#chatbut_connect").removeClass("online")});J.install();h.groupContainer.bind("mousewheel",M);h.chatWraper.bind("mousewheel",M)};this.toFront=function(){if(!c){G.destroy();return}$("body").find("."+A).css("z-index",i).removeClass(A);c.css("z-index",t).addClass(A)};function P(Q){var R=$('<div class="chatlistRightMenu">'+(Q.iscreator&&!Q.disabled?'<label><input name="newGroupName" value="'+Q.groupname+'"/></label>':"")+"<div>"+(Q.iscreator&&!Q.disabled?'<a id="chatbut_rename"><i class="fa fa-pencil"></i>\u6539\u540d</a>':"")+(Q.disabled?'<a id="chatbut_delete"><i class="fa fa-remove"></i>\u5220\u9664</a>':'<a id="chatbut_quit"><i class="fa fa-sign-out"></i>\u9000\u51fa</a>')+'<p class="cl"></p></div></div>');Q.iscreator&&!Q.disabled?null:R.width(114).find("a").width(110);var p=Q.groupid;var S=Q.groupname;R.find("a").bind("click",function(){var U=$(this).attr("id");switch(U){case"chatbut_delete":B.destroyGroup(p);$.destroyRightMenu();break;case"chatbut_rename":var T=a(R.find("input[name=newGroupName]").val());if(T!==S){J.updateGroupName(p,T);$.destroyRightMenu()}break;case"chatbut_quit":y(p);$.destroyRightMenu();break}}).data("data",Q);return R}function E(){var Q=a($(this).val()+"");if(Q==""){h.groupContainer.find(".selected").removeClass("selected");return}var S=w.getData(true);var R=false;for(var p=0;p<S.length;p++){if(S[p]["groupname"].indexOf(Q)>-1){S[p]["liObject"].addClass("selected");R=true}else{S[p]["liObject"].removeClass("selected")}}if(R){h.groupContainer.scrollTo(h.groupContainer.find(".selected:eq(0)"),300)}}function L(){switch($(this).attr("id")){case"chatbut_history":$(G).trigger("CHAT_HISTORY",{but:$(this)});break;case"chatbut_connect":if(!$(this).hasClass("online")){J.reConnect()}break;case"chatbut_creat":$(G).trigger("CHAT_CREATGROUP");break;case"chatbut_reload":var p=B.nowgroupid;w.reload();$(w).one("LOADED",function(){if(!p){return}var R=w.find("groupid",p);if(R){R.addClass("nowid")}});break;case"chatbut_close":G.showChatWindow(false);break;case"chatbut_user":G.showHideUserList(!$(this).hasClass("opened"));$(this).hasClass("opened")?$(this).removeClass("opened"):$(this).addClass("opened");break;case"chatbut_info":if(!G.option.detailTemplete){var Q=B.getNowGroup();$(G).trigger("CHAT_ADDINFO",{GID:Q.groupid,groupname:Q.groupname,jingqing:Q.jingqing})}else{G.showHideInfoBox(!$(this).hasClass("opened"));$(this).hasClass("opened")?$(this).removeClass("opened"):$(this).addClass("opened")}break;case"chatbut_add":var Q=B.getNowGroup();$(G).trigger("CHAT_ADDUSER",{GID:Q.groupid,groupname:Q.groupname});break;case"chatbut_remove":n();break;case"chatbut_detail":var Q=B.getNowGroup();$(G).trigger("CHAT_ADDINFO",{GID:Q.groupid,groupname:Q.groupname,jingqing:Q.jingqing});break;case"chatbut_reloadinfo":l.reload();break;case"chatbut_quit":y(B.nowgroupid);break}}this.showChatWindow=function(p){if(G.onshow==p){return}b.chatwidth=p?G.option.chatwidth:0;
b.userwidth=p&&m?G.option.userwidth:0;b.infowidth=G.option.detailTemplete&&p&&k?G.option.infowidth:0;p?h.chatWraper.show():h.chatWraper.hide();p?h.groupContainer.attr("dir","rtl"):h.groupContainer.attr("dir","ltr");q();this.onshow=p};this.showHideUserList=function(p){b.userwidth=!p?0:G.option.userwidth;!p?h.userbox.hide():h.userbox.show();m=p?true:false;q()};this.showHideInfoBox=function(p){if(!G.option.detailTemplete){return}b.infowidth=!p?0:G.option.infowidth;!p?h.infobox.hide():h.infobox.show();k=p?true:false;q()};this.resize=function(Q,p){if(!G.onshow){b.width=G.option.groupwidth;b.groupwidth=G.option.groupwidth;b.chatwidth=0;b.userwidth=0;b.infowidth=0}else{p.width=p.width>$(window).width()?$(window).width():p.width;b.chatwidth=p.width-b.groupwidth-b.infowidth-b.userwidth;b.chatwidth=b.chatwidth<G.option.chatminwidth?G.option.chatminwidth:b.chatwidth;G.option.chatwidth=b.chatwidth}p.height=p.height>$(window).height()?$(window).height():p.height;G.option.height=p.height;var R=G.option.maxheight?G.option.maxheight:$(window).height();G.option.height=(G.option.height>R)?R:G.option.height;G.option.height=(G.option.height<G.option.minheight)?G.option.minheight:G.option.height;q()};function q(){b.width=b.chatwidth+b.groupwidth+b.userwidth+b.infowidth;c.width(b.width).height(G.option.height);var p=G.option.height-c.find(".chatTitleBox").outerHeight(true);h.groupWraper.setRealSize(G.option.groupwidth,p);cW=b.width-G.option.groupwidth;h.chatWraper.setRealSize(cW,p);h.groupContainer.setRealSize(h.groupWraper.width(),h.groupWraper.height()-h.menuH);h.chatContainer.setRealSize(h.chatWraper.width(),h.chatWraper.height()-h.menuH);var Q=h.chatContainer.width()-b.infowidth-b.userwidth;var R=h.chatContainer.height();h.chatbox.setRealSize(Q,R);h.userbox.setRealSize(b.userwidth,R);h.infobox?h.infobox.setRealSize(b.infowidth,R):null;h.chatbox.find(".chatMsgContainer").setRealSize(h.chatbox.width(),h.chatbox.height()-h.sendH);h.userbox.find(".chatUserListContainer").setRealSize(h.userbox.width(),h.userbox.height()-h.footH);h.infobox?h.infobox.find(".chatInfoContainer").setRealSize(h.infobox.width(),h.infobox.height()-h.footH):null;if(B){B.resize()}l?l.resize():null}function s(R,p){var Q=w.find("groupid",p.groupid);if(Q){}else{w.insert(p,0)}}function g(Q,p){w.findAndRemove("groupid",p.groupid);if(B.nowgroupid==p.groupid){G.showChatWindow(false)}}function d(Q,p){h.chatWraper.find("#chat_groupname").html(p.groupname);w.findAndCheck("groupid",p.groupid,true);F();if(p.group["jingqing"]){c.find(".chatMainMenuBox a#chatbut_info").show();l?l.load({jingqing:p.group["jingqing"]}):null}else{c.find(".chatMainMenuBox a#chatbut_info").hide();l?l.clear():null}}this.showChat=function(){G.toFront();if(G.chatOn){return}c.show();$(G).trigger("CHAT_SHOW");G.chatOn=true};this.hideChat=function(){if(!G.chatOn){return}c.hide();$(G).trigger("CHAT_HIDE");G.chatOn=false};function F(){var p=B.getNowGroup();if(!p){return}p.disabled?h.chatWraper.find("#chatbut_add,#chatbut_remove,#chatbut_quit").hide():h.chatWraper.find("#chatbut_add,#chatbut_remove,#chatbut_quit").show();p.disabled?r.disable(true):r.disable(false);p.disabled?h.chatWraper.find("#chat_groupname").addClass("disabled"):h.chatWraper.find("#chat_groupname").removeClass("disabled");!p.iscreator||p.disabled?h.chatWraper.find("#chatbut_add,#chatbut_remove").hide():h.chatWraper.find("#chatbut_add,#chatbut_remove").show();!p.jingqing?h.chatWraper.find("#chatbut_detail,#chatbut_reloadinfo").hide():h.chatWraper.find("#chatbut_detail,#chatbut_reloadinfo").show();h.userbox.find("li span").removeClass("checked")}function y(Q){var S=B.getGroup(Q);if(!S){S=w.findRowData("groupid",Q)}if(S){var p={groupid:Q,delroup:S.iscreator};var R=function(U){S.disabled=true;j(Q);F()};var T=S.iscreator?"\u9000\u51fa\u540e\u8be5\u4f1a\u8bdd\u5c06\u4f1a\u89e3\u6563\uff0c\u786e\u5b9a\u5417\uff1f":"\u9000\u51fa\u8be5\u4f1a\u8bdd\u4e0d\u518d\u63a5\u6536\u6d88\u606f\uff0c\u786e\u5b9a\u5417\uff1f";$.confirm(T,function(U){if(U){J.quit(p,R)}})}}function j(Q){var p=w.findRowData("groupid",Q);if(p){p.disabled=true;p.liObject.addClass("dismissed")}var R=B.getGroup(Q);if(R){R.disabled=true}}function v(){if($(this).hasClass("disabled")){return}var p=B.getNowGroup();if($(this).hasClass("addinfo")){$(G).trigger("CHAT_ADDINFO",{GID:p.groupid,groupname:p.groupname,jingqing:p.jingqing})}else{if($(this).hasClass("delren")){n()}else{if($(this).hasClass("addren")){$(G).trigger("CHAT_ADDUSER",{GID:p.groupid,groupname:p.groupname})}}}}this.addUserlist=function(Q,p){if(!Q||!p){return}var R=function(S){B.addToUserList(S,p)};J.addUser(Q,p,R)};this.gotList=function(S){if(!S||S.length<1){return}for(var R=0;R<S.length;R++){if(!S[R]||!S[R]["users"]||S[R]["users"].length<1){}else{var p=S[R]["groupid"];var Q=S[R]["users"];B.updateUserList(Q,p)}}};this.gotGroup=function(p){if(!p||p.length<1){return}for(var R=0;R<p.length;R++){var Q=p[R]["groupid"];f(Q,p[R])}};function f(Q,p){var S=B.getGroup(Q);if(S){$.extend(S,p)}if(B.nowgroupid==Q){h.chatWraper.find("#chat_groupname").html(p.groupname);
F()}w.update("groupid",Q,p,true);var R=w.find("groupid",Q);if(p.disabled){R?R.addClass("dismissed"):null}else{R?R.removeClass("dismissed"):null}}function x(T,U){var Q=U.groupid;var p=U.groupname;var S=B.getGroup(Q);if(S){S.groupname=p}if(B.nowgroupid==Q){h.chatWraper.find("#chat_groupname").html(p)}var R=w.find("groupid",Q);lidata=R.data("data");lidata.groupname=p;w.update("groupid",Q,lidata,true)}function n(){var p=B.prepareDelete();if(!p){return}var Q=function(){B.deleteUser(p)};J.delUser(p.delids,p.groupid,Q)}var H;function C(U,S){var Q=S.open;var p=S.groupid;var T=S.oldmsg;if(H&&H==p){return}var R=function(V){H=null;var W=0;if(T){V.msg=T;W=T.length}B.creatGroupObj(V);if(Q){B.showGroup(p)}p!=B.nowgroupid?I(p,W):null};H=p;J.LoadGroup(p,R)}this.openGroup=function(Q,p){G.showChat();G.showChatWindow(true);r.focus();B.showGroup(Q);I(Q)};this.creatGroup=function(p){G.showChat();G.showChatWindow(true);var Q=function(R){var S=R.groupid;B.creatGroupObj(R);B.showGroup(S);w.findAndCheck("groupid",S,true);h.groupContainer.scrollTo(0,300);$(G).trigger("CHAT_INSERTGROUP",R)};J.newGroup(p,Q)};this.gotMsg=function(T,R){if(!T||T.length<1){return}if(!G.chatOn&&!R){$(G).trigger("CHAT_NEW_MSG",{num:T.length})}var S={};for(var Q=0;Q<T.length;Q++){var p="g_"+T[Q]["groupid"];if(!S[p]){S[p]=[]}S[p].push(T[Q])}B.reciveMsg(S);for(var p in S){z(S[p][0]["groupid"],S[p].length)}if(G.option.sound&&!T[0]["self"]&&D&&!R){D.play(true)}};function z(Q,p){if(Q==B.nowgroupid){return}var S=w.find("groupid",Q);if(S){var T=S.find("span.newmsg");var R=parseInt(T.text()+"");R=isNaN(R)?0:R;R+=p;R=R>99?"99+":R;T.text(R).show()}}function I(p,Q){var R=w.find("groupid",p);Q=!Q?"":Q;if(R){var S=R.find("span.newmsg");S.text(Q);(Q==""||p==B.nowgroupid)?S.hide():S.show()}}this.sendMsg=function(R,p){var Q=B.getNowGroup();if(!Q){return}if(Q.disabled){$.alert("\u4f1a\u8bdd\u7ec4\u5df2\u89e3\u6563");return}J.send(R,Q.groupid,p)};var N;function u(R){R=R?R:window.event;N=[R.clientX,R.clientY];var T=c.css("left");T=parseInt(T.replace("px",""));T=T?T:0;var p=c.css("top");p=parseInt(p.replace("px",""));p=p?p:0;var S=function(V){V=V?V:window.event;var U=T+(V.clientX-N[0]);var W=p+(V.clientY-N[1]);W=(W>0)?W:0;c.css({left:U+"px",top:W+"px"})};var Q=function(U){$(document).unbind("mousemove",S).unbind("mouseup",Q)};$(document).bind("mousemove",S).bind("mouseup",Q)}this.destroy=function(){if(J){J.destroy();J=null}if(c){c.del();c=null}if(B){B.destroy();B=null}};function e(R,Q){c.find("#popShowMessage").stop().del();var p=$('<div id="popShowMessage">'+R+"</div>");c.find(".chatContainer").append(p);p.css({position:"absolute",bottom:"80px",padding:"8px",left:"15%",width:"70%","text-align":"center","z-index":"9999999","background-color":"#000",color:"#fff","border-radius":"6px",opacity:0.6});p.hide().fadeIn("fast").delay(Q).fadeOut("slow",function(){c.find("#popShowMessage").stop().del()}).bind("mousedown",function(){c.find("#popShowMessage").stop().del()})}function a(p){return(p+"").replace(/^\s*|\s*$/g,"")}function M(p){p.stopPropagation()}}function ChatBox(g,j){var a=this;var c=[];this.nowgroupid;this.maxmsg=100;this.install=function(){g.css({position:"relative"})};this.resize=function(){j.find(".chatuserlist").height(j.height());g.find(".chatmsglist").height(g.height())};this.getGroup=function(o){for(var p=0;p<c.length;p++){if(c[p]["groupid"]==o){return c[p];break}}return null};this.getNowGroup=function(){return a.getGroup(a.nowgroupid)};this.destroy=function(){c.splice(0,c.length);c=null};this.creatGroupObj=function(o){var q=a.getGroup(o.groupid);if(q){return q}q={creatorid:o.userId,chatbox:null,list:null,iscreator:o.iscreator};$.extend(q,o);q.list=$('<div class="chatuserlist"></div>');j.append(q.list);q.list.hide();q.chatbox=$('<div class="chatmsglist"></div>');g.append(q.chatbox);q.chatbox.hide();c.push(q);q.list.height(q.list.parent().height());q.chatbox.height(q.list.parent().height());a.updateUserList(o.userlist,o.groupid);var p=o.msg;a.reciveMsg({g_oldmsg:p});$(a).trigger("CREAT_GROUP",o);return q};this.destroyGroup=function(o){var q=a.getGroup(o);if(!q){$(a).trigger("DELETE_GROUP",{groupid:o});return}q.chatbox.del();q.chatbox=null;q.list.del();q.list=null;for(var p=0;p<c.length;p++){if(c[p]["groupid"]==o){c[p]=null;c.splice(p,1);break}}$(a).trigger("DELETE_GROUP",{groupid:o})};this.showGroup=function(o){if(!o){return}var p=a.getGroup(o);if(p){g.find(">div").hide();j.find(">div").hide();p.chatbox.show();p.list.show();a.nowgroupid=o;$(a).trigger("CHANGE_GROUP",{groupid:o,groupname:p.groupname,disabled:p.disabled,group:p})}else{$(a).trigger("OPEN_GROUP",{groupid:o,open:true})}};function b(o){chatWindow.find(".chatMsgBox>div").hide();o.chatbox.show()}this.updateUserList=function(p,o){var q=a.getGroup(o);if(!q){return}if(p.length<1){return}q.list.find("ul>li").del();m(p,q.list,q)};function m(q,u,t){for(var r=0;r<q.length;r++){var s=q[r]["orgCode"];s=s?s:"othergroup";var p=u.find("#"+s);if(p.length==0){p=$('<div class="userpart" id="'+s+'"><h1><span></span>'+(q[r]["orgName"]||"\u5176\u4ed6")+"</h1><ul></ul></div>");
u.append(p);p.find("h1").bind("click",d);p.find(">ul").hide()}var o=$('<li rel="'+q[r]["userId"]+'">'+q[r]["userName"]+"</li>");p.find("ul").append(o);if(t.iscreator&&q[r]["userId"]!=t.creatorid){o.prepend($("<span></span>"));o.find("span").bind("click",k)}}n(u)}function n(o){o.find(">div.userpart").each(function(){var p=$(this).find(">ul>li").length;if(p==0){$(this).del()}else{$(this).find(">h1>span").text(p+"")}})}function d(){var o=$(this).parent();if($(this).hasClass("open")){o.find(">ul").hide();$(this).removeClass("open")}else{o.find(">ul").show();$(this).addClass("open")}}this.addToUserList=function(q,o){var s=a.getGroup(o);if(!s){return}var p=[];for(var r=0;r<q.length;r++){if(!i(q[r],s)){p.push(q[r])}}if(p.length<1){return}m(p,s.list,s)};function i(o,q){var p=q.list.find("li[rel="+o.userId+"]");if(p.length>0&&p.eq(0).text()==o.userName){return true}return false}this.prepareDelete=function(){var p=a.getGroup(a.nowgroupid);var o=[];p.list.find("li").each(function(){if($(this).find(">span").hasClass("checked")){o.push($(this).attr("rel"))}});if(o.length<1){return}if((p.list.find("li").length-o.length)<2){$.alert("\u4e00\u4e2a\u4f1a\u8bdd\u81f3\u5c11\u6709\u4e24\u4eba\u53c2\u4e0e");return null}return{delids:o,groupid:a.nowgroupid}};this.deleteUser=function(p){var o=p.delids;var r=a.getGroup(p.groupid);for(var q=0;q<o.length;q++){r.list.find("li[rel="+o[q]+"]").del()}n(r.list)};function k(){$(this).hasClass("checked")?$(this).removeClass("checked"):$(this).addClass("checked")}this.reciveMsg=function(r){if(!r){return}for(var o in r){if(r[o]){var p=r[o][0]["groupid"];var s=a.getGroup(p);if(s){for(var q=0;q<r[o].length;q++){f(p,r[o][q],(q==r[o].length-1))}}else{$(a).trigger("OPEN_GROUP",{groupid:p,open:false,oldmsg:r[o]})}}}};function f(q,x,v){var w=a.getGroup(q);var s;var o=w.chatbox.find(">div.msgOutBox:last");var u=(o.length>0)?Math.floor(o.position().top+o.outerHeight(true)-w.chatbox.height()):0;s=(u>60);var p=h(x);w.chatbox.append(p);if(v){var t=w.chatbox.find(">div").length-a.maxmsg;t>0?w.chatbox.find(">div:lt("+t+")").del():null}if(!s&&q==a.nowgroupid){setTimeout(function(){w.chatbox.scrollTo(p,300)},500)}else{if(s&&q==a.nowgroupid){var r=w.chatbox.find(">dd.msgtip");if(r.length==0){r=$('<dd class="msgtip"><p>\u6709\u65b0\u6d88\u606f</p></dd>');g.append(r);w.chatbox.one("scroll",e);r.css({position:"absolute",right:"28px",bottom:"2px","z-index":999});r.hide().fadeIn("slow")}r.unbind().one("click",function(){w.chatbox.scrollTo(p,300);e()})}}}function e(){g.find(">dd.msgtip").stop(true).del()}function h(r){if(r.type&&r.type==9){var q='<div class="systemMsg">'+r.chat+"</div>";var p=$(q);return p}var o=r.type&&r.type>1?true:false;var q;if(o){if(r.type==2){q='<img src="'+r.chat+'" />'}else{if(r.type==3){q='<a class="mediabut msg_sound" rel="'+r.chat+'">'+(r.size||"\u64ad\u653e\u97f3\u9891")+"</a>"}else{if(r.type==4){q='<a class="mediabut msg_video" rel="'+r.chat+'">'+(r.size||"\u64ad\u653e\u89c6\u9891")+"</a>"}else{if(r.type==5){q='<a class="mediabut msg_file" href="'+r.chat+'" target="_blank">\u4e0b\u8f7d\u6587\u4ef6</a>'}}}}}else{q=r.chat+""}q='<div class="msgOutBox '+(r.self?"selfmsg":"")+'"><div class="msgPopBox"><h5>'+r.chattime+"</h5><h4>"+(r.orgName?"<strong>"+r.orgName+"</strong>":"")+r.userName+": </h4><p>"+q+'</p></div><div class="cl"></div></div>';var p=$(q);p.find("img").ZoomBigPic();p.find("a.mediabut").bind("click",l);p.hide().fadeIn("slow");return p}function l(){var o=$(this).attr("rel");if($(this).hasClass("msg_sound")){$(a).trigger("CHAT_VOICE",{url:o})}else{if($(this).hasClass("msg_video")){$(a).trigger("CHAT_VIDEO",{url:o,butobj:$(this)})}else{if($(this).hasClass("msg_file")){}}}}this.gotList=function(r){if(!r||r.length<1){return}for(var q=0;q<r.length;q++){if(!r[q]||!r[q]["users"]||r[q]["users"].length<1){}else{var o=r[q]["groupid"];var s=a.getGroup(o);if(s){s.list.find("ul").empty();var p=r[q]["users"];a.addToUserList(p,o)}}}};this.install()}function ChatInput(b){var h=this;var a="webchatUpload_"+(new Date()).getTime();this.uploadUrl;var d;this.install=function(){b.empty().html('<div style="width:70%;float:left;"><div id="msginput" contenteditable="true"></div></div><div style="width:10%;float:left;"><dd><input type="file" name="sendPic" id="'+a+'"/></dd></div><div style="width:20%;float:right;"><a>\u53d1\u9001</a></div><div class="cl"></div>');b.find("a").unbind().bind("click",f);b.find("#msginput").unbind().bind("paste",delInputHtml);b.find("input[name=sendPic]").unbind().bind("change",g);d=b.find("#msginput");d.unbind("keydown",e).bind("keydown",e)};this.disable=function(i){if(i){d.attr("contenteditable",false).addClass("disabled");b.find("a").unbind();d.unbind("keydown",e);b.find("input[name=sendPic]").attr("disabled",true)}else{d.attr("contenteditable",true).removeClass("disabled");b.find("a").unbind().bind("click",f);d.unbind("keydown",e).bind("keydown",e);b.find("input[name=sendPic]").attr("disabled",false)}};function e(i){if(i.ctrlKey&&i.keyCode==13){f()}}this.focus=function(){b.find("#msginput").get(0).focus()
};function f(){if(trim(d.text())==""){d.html("");return}d.attr("contenteditable",false);var i=trim(d.html());i=clearHtml(i);if(i!=""){$(h).trigger("SEND_MSG",{msg:i,add:null})}d.html("");d.attr("contenteditable",true).get(0).focus()}function g(){var n=$(this);var l=n.val();var m=l.split(".");m=m[m.length-1];m=m.toLowerCase();switch(m){case"jpg":case"jpeg":case"png":case"gif":case"bmp":m=2;break;case"mp3":case"wav":m=3;break;case"flv":case"f4v":case"mp4":m=4;break;default:m=5;break}var i=function(o,p){$(h).trigger("UPLOAD_END");$(h).trigger("ERROR",{msg:"\u4e0a\u4f20\u5931\u8d25"+(p.msg||"")});c(true)};var k=function(o,q){if(q.head["code"]==1){var p=q.value["filename"];$(h).trigger("UPLOAD_END");$(h).trigger("SEND_MSG",{msg:p,add:$.extend({type:m,size:"PLAY"},q.value)})}else{i(q.head["message"])}c(true)};var j=function(){c(false);var p=b.find("input[name=sendPic]");var o=new MAjaxUpload(p,h.uploadUrl);$(o).one("UPLOAD_COMPLETE",k).one("UPLOAD_ERROR",i);o.upLoad()};$(h).trigger("UPLOAD_START");j()}function c(i){if(i){b.find("input[name=sendPic]").show().unbind().val("").bind("change",g)}else{b.find("input[name=sendPic]").hide()}}this.install()}function chatInfoDetail(b,j,d){var c=this;var i;var h;var a;var g;var f;this.install=function(){if(!d||!j){$.errormsg("\u8bf7\u68c0\u67e5\u6a21\u677f\u914d\u7f6e");return}LoadHtml(d,{},function(l,k){i=k});g=$("<div></div>");b.empty().append(g);g.css({"overflow-x":"hidden","overflow-y":"auto"});c.resize()};this.load=function(k){f=k;c.reload()};this.reload=function(){if(a){a.destroy();a=null}a=new AJAXObj();$(a).bind("JSON_LOADED",function(l,k){e(k.value)}).bind("SYS_ERROR",c.clear);a.POSTDATA(j,creatPostParam("chatDetail",f))};this.resize=function(){g.setRealSize(null,b.height())};this.clear=function(){g.empty();b.addClass("noContent")};function e(l){g.empty();b.removeClass("noContent");if(!i){$.errormsg("\u8bf7\u68c0\u67e5\u6a21\u677f");return}var k=$(i);g.append(k);k.bindJsonData(l)}}var WEBCHATSOCKET;function ChatCore(l){var n=this;this.option=l;var m;var u;var o="webchatUpload_"+(new Date()).getTime();var x=false;var j=[];var h=[];var v=0;var t=10;var b=false;this.install=function(){Loader=new AJAXObj();Loader.silent=true;switch(n.option.listener){case"socket_http":w();break;case"push":f();break;case"http":z();break}};function w(){if(!n.option.socketPort||!n.option.socketHost||!n.option.swfPath){return}m=new AJAXObj();m.silent=true;if(n.option.timeout){m.timeout=n.option.timeout}var p=$('<div id="webChartSocket"></div>');p.css({position:"fixed","z-index":-1,width:"1px",height:"1px"});$("body").append(p);WEBCHATSOCKET=new swfSocket(p,n.option.swfPath,"WEBCHATSOCKET",n.option.debug);$(WEBCHATSOCKET).bind("SOCKET_CONNECTED",function(){$(n).trigger("SOCKET_CONNECTED")}).bind("SOCKET_FAIL  CONNECT_ERROR  CONNECT_BREAK  SECURTY_ERROR",function(B){$(n).trigger("SOCKET_CONNECT_FAIL",B)}).bind("SOCKET_DATA",r);WEBCHATSOCKET.install(n.option.socketHost,n.option.socketPort)}this.reConnect=function(){WEBCHATSOCKET?WEBCHATSOCKET.reConnect():null};function r(D,p){if(!p||!p.data){return}var C=p.data;C=typeof C=="object"?C:[C];for(var B=0;B<C.length;B++){j.push(C[B])}j=unique(j);if(j.length>0&&!b){y()}}function y(){h.splice(0,h.length);for(var B=0;B<j.length;B++){h.push(j[B])}j.splice(0,j.length);var C=function(){v=0;h.splice(0,h.length);if(j.length>0){y()}else{b=false}};var p=function(){j=h.concat(j);if(v>=t){$(n).trigger("GET_MESSAGE_FAIL");v=0;b=false}else{v++;y()}};b=true;n.readMessage({msgid:h},p,C)}this.sendBySocket=function(p){WEBCHATSOCKET?WEBCHATSOCKET.send(p):null};function f(){var F=n.option.userName||"";var D=n.option.password||"";var C=null;var p={};var E=new JmsConnectionFactory(url);var B=E.createConnection(F,D,function(){try{C=B.getValue();C.setExceptionListener=function(K){$(n).trigger("ERROR",{errmsg:"\u6d88\u606f\u670d\u52a1\u51fa\u9519"})};var J=C.createSession(false,Session.AUTO_ACKNOWLEDGE);var G=J.createTopic(n.option.topic);var H=J.createConsumer(G);H.setMessageListener(k);C.start(function(){})}catch(I){$(n).trigger("ERROR",{errmsg:"\u6d88\u606f\u670d\u52a1\u8fde\u63a5\u5931\u8d25"})}})}function k(p){if(x){return}var C=p.getText();try{C=JSON.parse(C)}catch(B){return}d(A(C)["msg"]);c(A(C)["userlist"])}this.stop=function(){if(u){clearTimeout(u);u=null}x=true};var e=0;this.start=function(){if(n.option.listener=="http"){n.stop();u=setTimeout(function(){var p=function(){e++;e=e>600?600:e;n.start()};n.readMessage({},p)},n.option.timer+e*1000)}x=false};this.readMessage=function(B,C,D){var p=i("msg",B);$(m).unbind().one("JSON_LOADED",function(F,E){s(F,E);typeof D=="function"?D(B):null}).one("SYS_ERROR",C);m.POSTDATA(n.option.hostPort,p,false)};function z(){if(!n.option.timer||!n.option.hostPort){return}m=new AJAXObj();m.silent=true;if(n.option.timeout){m.timeout=n.option.timeout}n.start()}function s(B,p){e=0;d(A(p)["msg"]);c(A(p)["userlist"]);g(A(p)["groups"]);n.start()}function d(B){if(B&&B.length>0){for(var p=0;p<B.length;p++){B[p]["chat"]=formatHtml(B[p]["chat"])}$(n).trigger("GOT_MESSAGE",{msg:B})
}}function c(p){if(p&&p.length>0){$(n).trigger("GOT_USERLIST",{list:p})}}function g(p){if(p&&p.length>0){$(n).trigger("GOT_GROUP",{groups:p})}}this.send=function(E,C,F){F=F?F:{};var B=function(G){var H=new Date();H=a(H.getHours())+":"+a(H.getMinutes())+":"+a(H.getSeconds());var I={groupid:C,self:true,chattime:H,chat:""+E,userName:"\u6211"};$.extend(I,F);d([I])};if(!E){return}var D={groupid:C,msg:E};$.extend(D,F);var p=i("send",D);q(p,B,"\u6d88\u606f\u53d1\u9001\u5931\u8d25")};this.quit=function(B,C){var p=i("quit",B);q(p,C,"\u9000\u51fa\u5931\u8d25")};this.addUser=function(C,B,E){if(!C||C.length<1){return}var D=function(F){var G=F.userlist;E(G);if(F.groupname){$(n).trigger("UPDATE_GROUPNAME",{groupname:F.groupname,groupid:B})}};var p=i("addren",{users:C,groupid:B});q(p,D,"\u6dfb\u52a0\u4eba\u5458\u5931\u8d25")};this.delUser=function(C,B,D){var p=i("delren",{guid:C,groupid:B});q(p,D,"\u7ec4\u4eba\u5458\u5220\u9664\u5931\u8d25")};this.newGroup=function(B,C){var p=i("newgroup",B);q(p,C,"\u521b\u5efa\u7ec4\u5931\u8d25")};this.LoadGroup=function(B,C){var p=i("getgroup",{groupid:B});q(p,C,"\u7ec4\u4fe1\u606f\u52a0\u8f7d\u5931\u8d25")};this.updateGroupName=function(C,B){var p=i("renamegroup",{groupid:C,newgroupname:B});q(p,function(E,D){$(n).trigger("UPDATE_GROUPNAME",{groupname:B,groupid:C})},"\u7ec4\u540d\u79f0\u66f4\u65b0\u5931\u8d25")};function q(p,D,B){var C=new AJAXObj();$(C).unbind().one("JSON_LOADED",function(F,E){C.destroy();C=null;var E=A(E);D(E)}).one("SYS_ERROR",function(){C.destroy();C=null;$(n).trigger("ERROR",{errmsg:B})});C.POSTDATA(n.option.hostPort,p)}function i(B,C,D){var p=$.extend({},n.option.param||{},C);return creatPostParam(B,p,D)}function A(p){return p.value}function a(p){p+="";return p.length>1?p:"0"+p}this.destroy=function(){if(u){clearTimeout(u);u=null}if(Loader){$(Loader).unbind();Loader=null}if(m){$(m).unbind();m=null}}};